<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>الرئيسية</title>

<script src="https://www.youtube.com/iframe_api"></script>

<style>
body {
  margin: 0;
  background: black;
  color: white;
  font-family: Arial;
  height: 100vh;
  overflow-y: scroll;
  scroll-snap-type: y mandatory;
}

/* TOP BAR */
.topbar {
  position: fixed;
  top: 0;
  width: 100%;
  height: 55px;
  background: rgba(0,0,0,.85);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 15px;
  z-index: 1000;
}

.balance { font-size: 16px; }
.dots { font-size: 28px; cursor: pointer; user-select: none; }

/* DROPDOWN */
.dropdown {
  position: absolute;
  top: 55px;
  right: 10px;
  background: #1e1e1e;
  border-radius: 10px;
  display: none;
  flex-direction: column;
  min-width: 180px;
  box-shadow: 0 10px 25px rgba(0,0,0,.5);
}

.dropdown div,
.dropdown button {
  padding: 12px;
  color: white;
  background: none;
  border: none;
  text-align: right;
}

.dropdown button:hover {
  background: #333;
}

/* VIDEO */
.video {
  height: 100vh;
  scroll-snap-align: start;
  position: relative;
  margin-top: 55px;
}

iframe {
  width: 100%;
  height: 100%;
  pointer-events: none;
}

/* CONTROLS */
.controls {
  position: absolute;
  right: 15px;
  bottom: 120px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.controls button {
  background: rgba(0,0,0,.6);
  color: white;
  border: none;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  font-size: 18px;
  cursor: pointer;
}

.controls button.active {
  background: #3f8efc;
}

/* ADD BUTTON */
.add-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 55px;
  height: 55px;
  border-radius: 50%;
  background: #3f8efc;
  color: white;
  font-size: 32px;
  border: none;
  cursor: pointer;
  z-index: 1500;
}

/* MODAL */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.modal-content {
  background: #111;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 350px;
}

.modal-content input {
  width: 100%;
  padding: 8px;
}
</style>
</head>

<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="balance" id="balance">0 ﷼</div>
  <div class="dots" onclick="toggleMenu()">⋯</div>

  <div class="dropdown" id="dropdown">
    <div id="username">اسم المستخدم</div>
    <button onclick="alert('ستضاف لاحقًا')">معلومات المستخدم</button>
    <button onclick="logout()">تسجيل الخروج</button>
  </div>
</div>

<!-- VIDEOS -->
<div id="videos"></div>

<!-- ADD VIDEO BUTTON -->
<button class="add-btn" onclick="openAdd()">＋</button>

<!-- ADD VIDEO MODAL -->
<div class="modal" id="addModal">
  <div class="modal-content">
    <h3>إضافة فيديو</h3><br>

    <input id="yt" placeholder="رابط YouTube"><br><br>

    <strong>المناطق:</strong><br>
    <label><input type="checkbox" value="الشرقية"> الشرقية</label><br>
    <label><input type="checkbox" value="الوسطى"> الوسطى</label><br>
    <label><input type="checkbox" value="الغربية"> الغربية</label><br><br>

    <button onclick="saveVideo()">حفظ الفيديو</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, doc, getDoc, collection, getDocs,
  addDoc, setDoc, updateDoc, increment
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const app = initializeApp({
  apiKey: "AIzaSyB4tTVOD8P95EUzmOFNkco9AKI0wP1dLW0",
  authDomain: "salh01.firebaseapp.com",
  projectId: "salh01"
});
const auth = getAuth();
const db = getFirestore();

/* GLOBALS */
let currentUser, userData;
let players = {};
let currentPlaying = null;

/* AUTH */
onAuthStateChanged(auth, async user => {
  if (!user) return location.href = "login.html";
  currentUser = user;

  const snap = await getDoc(doc(db, "users", user.uid));
  userData = snap.data();

  document.getElementById("username").innerText = userData.name;
  document.getElementById("balance").innerText = userData.balance + " ﷼";

  loadVideos();
});

/* LOAD VIDEOS */
async function loadVideos() {
  const snap = await getDocs(collection(db, "videos"));
  const container = document.getElementById("videos");

  snap.forEach(d => {
    const v = d.data();
    if (!v.regions.includes(userData.region)) return;

    const div = document.createElement("div");
    div.className = "video";
    div.innerHTML = `
      <div id="player-${d.id}"></div>
      <div class="controls">
        <button id="like-${d.id}">★</button>
        <button id="watch-${d.id}">✔</button>
      </div>
    `;
    container.appendChild(div);

    players[d.id] = { youtubeId: v.youtubeId };
    setupLike(d.id);
  });
}

/* YOUTUBE */
window.onYouTubeIframeAPIReady = () => {
  Object.keys(players).forEach(id => {
    players[id].player = new YT.Player(`player-${id}`, {
      videoId: players[id].youtubeId,
      playerVars: { controls: 0 },
      events: {
        onStateChange: e => handleState(e, id)
      }
    });
  });
};

/* VIDEO STATE */
async function handleState(e, videoId) {
  if (e.data === YT.PlayerState.PLAYING) {
    if (currentPlaying && currentPlaying !== videoId) {
      players[currentPlaying].player.pauseVideo();
    }
    currentPlaying = videoId;
  }

  if (e.data === YT.PlayerState.ENDED) {
    const ref = doc(db, "interactions", `${currentUser.uid}_${videoId}`);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      await setDoc(ref, { watched: true });
      await updateDoc(doc(db, "users", currentUser.uid), {
        balance: increment(0.5)
      });
      userData.balance += 0.5;
      document.getElementById("balance").innerText = userData.balance + " ﷼";
    }

    document.getElementById(`watch-${videoId}`).classList.add("active");
  }
}

/* LIKE */
async function setupLike(videoId) {
  const btn = document.getElementById(`like-${videoId}`);
  const ref = doc(db, "interactions", `${currentUser.uid}_${videoId}`);
  const snap = await getDoc(ref);

  if (snap.exists() && snap.data().liked) btn.classList.add("active");

  btn.onclick = async () => {
    await setDoc(ref, { liked: true }, { merge: true });
    btn.classList.add("active");
  };
}

/* ADD VIDEO */
window.openAdd = () => {
  document.getElementById("addModal").style.display = "flex";
};

window.saveVideo = async () => {
  const url = document.getElementById("yt").value.trim();
  let youtubeId = "";

  if (url.includes("watch?v=")) {
    youtubeId = url.split("watch?v=")[1].split("&")[0];
  } else if (url.includes("youtu.be/")) {
    youtubeId = url.split("youtu.be/")[1].split("?")[0];
  }

  if (!youtubeId) return alert("رابط غير صحيح");

  const regions = [...document.querySelectorAll('#addModal input:checked')]
    .map(c => c.value);

  if (!regions.length) return alert("اختر منطقة");

  await addDoc(collection(db, "videos"), {
    youtubeId,
    regions,
    order: Date.now()
  });

  location.reload();
};

/* MENU */
window.toggleMenu = () => {
  const d = document.getElementById("dropdown");
  d.style.display = d.style.display === "flex" ? "none" : "flex";
};

document.addEventListener("click", e => {
  const m = document.getElementById("dropdown");
  const d = document.querySelector(".dots");
  if (!m.contains(e.target) && !d.contains(e.target)) m.style.display = "none";
});

/* LOGOUT */
window.logout = () => signOut(auth).then(() => location.href = "login.html");
</script>

</body>
</html>
