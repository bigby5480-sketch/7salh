<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ÙÙŠØ¯ÙŠÙˆ Ø¨Ù…ÙƒØ§ÙØ£Ø©</title>

<style>
body {
  margin:0;
  background:#000;
  color:#fff;
  font-family:Arial;
}
header {
  background:#111;
  padding:10px;
  display:flex;
  gap:10px;
}
input {
  flex:1;
  padding:10px;
}
button {
  padding:10px;
  cursor:pointer;
}
.video {
  position:relative;
  width:100%;
  height:300px;
  margin-top:10px;
}
.reward {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  display:none;
  justify-content:center;
  align-items:center;
  font-size:24px;
  z-index:999;
}
</style>
</head>

<body>

<header>
  <input id="yt" placeholder="Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨">
  <button onclick="addVideo()">Ø¥Ø¶Ø§ÙØ©</button>
</header>

<div id="videos"></div>

<div class="reward" id="reward">
  ğŸ‰ ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©
</div>

<script src="https://www.youtube.com/iframe_api"></script>

<script type="module">
/* ===== Firebase ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  increment
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyB4tTVOD8P95EUzmOFNkco9AKI0wP1dLW0",
  authDomain: "salh01.firebaseapp.com",
  projectId: "salh01"
});

const auth = getAuth();
const db = getFirestore();

let user;
onAuthStateChanged(auth,u=>{
  if(!u) location.href="login.html";
  user=u;
});

/* ===== YouTube ===== */
let index=0;
let players={};
let state={};

window.addVideo = async()=>{
  const link=document.getElementById("yt").value;
  const id=getId(link);
  if(!id) return alert("Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­");

  const videoKey=id;
  const watchedRef=doc(db,"watched",`${user.uid}_${videoKey}`);
  const watchedSnap=await getDoc(watchedRef);
  if(watchedSnap.exists()){
    alert("ØªÙ… Ù…Ø´Ø§Ù‡Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø³Ø§Ø¨Ù‚Ù‹Ø§");
    return;
  }

  const pid="p"+(++index);
  state[pid]={played:false,locked:false,last:0,videoKey};

  const div=document.createElement("div");
  div.className="video";
  div.innerHTML=`<div id="${pid}"></div>`;
  videos.prepend(div);

  players[pid]=new YT.Player(pid,{
    videoId:id,
    playerVars:{
      controls:1,
      playsinline:1,
      disablekb:1,
      rel:0
    },
    events:{
      onStateChange:e=>onState(e,pid)
    }
  });
};

/* ===== Ù…Ù†Ø¹ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… ===== */
function onState(e,pid){
  const p=players[pid];
  const s=state[pid];

  if(e.data===YT.PlayerState.PLAYING){
    if(!s.played){
      s.played=true;
      s.last=p.getCurrentTime();
      s.timer=setInterval(()=>{
        const t=p.getCurrentTime();
        if(t>s.last+1.2){
          p.seekTo(s.last,true);
        }else{
          s.last=t;
        }
      },500);
    }
  }

  if(e.data===YT.PlayerState.ENDED && s.played){
    clearInterval(s.timer);
    reward(pid);
  }
}

/* ===== Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ===== */
async function reward(pid){
  const s=state[pid];
  const ref=doc(db,"watched",`${user.uid}_${s.videoKey}`);
  const snap=await getDoc(ref);
  if(snap.exists()) return;

  await setDoc(ref,{done:true});
  await updateDoc(doc(db,"users",user.uid),{
    balance:increment(0.5)
  });

  rewardBox.style.display="flex";
}

const rewardBox=document.getElementById("reward");

/* ===== Ø§Ø³ØªØ®Ø±Ø§Ø¬ ID ===== */
function getId(url){
  try{
    const u=new URL(url);
    if(u.hostname.includes("youtu.be"))
      return u.pathname.slice(1);
    return u.searchParams.get("v");
  }catch{
    return null;
  }
}
</script>

</body>
</html>
