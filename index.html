<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>

<style>
body{
  margin:0;
  background:black;
  color:white;
  font-family:Arial;
  height:100vh;
  overflow-y:scroll;
  scroll-snap-type:y mandatory;
}

/* ===== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ===== */
.top-bar{
  position:fixed;
  top:0;
  right:0;
  left:0;
  height:55px;
  background:#111;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 15px;
  z-index:1000;
  border-bottom:1px solid #222;
}

.balance{
  font-size:16px;
  font-weight:bold;
  color:#3f8efc;
}

.user-menu{ position:relative; }

.user-name{
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:6px;
}

.dropdown{
  position:absolute;
  top:40px;
  left:0;
  background:#1a1a1a;
  border-radius:8px;
  overflow:hidden;
  display:none;
  min-width:160px;
}

.dropdown div{
  padding:10px;
  cursor:pointer;
}
.dropdown div:hover{ background:#333; }

/* ===== Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ===== */
#videos{ margin-top:55px; }

.video{
  height:100vh;
  scroll-snap-align:start;
  position:relative;
}

video{
  width:100%;
  height:100%;
  object-fit:cover;
  background:black;
}

.delete-btn{
  position:absolute;
  top:15px;
  left:15px;
  z-index:20;
  background:red;
  color:white;
  border:none;
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
}

.reward-overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.85);
  z-index:30;
  display:none;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  font-size:22px;
}

/* ===== Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© ===== */
.add-btn{
  position:fixed;
  bottom:20px;
  right:20px;
  width:55px;
  height:55px;
  border-radius:50%;
  background:#3f8efc;
  color:white;
  font-size:30px;
  border:none;
  z-index:100;
  cursor:pointer;
}

/* ===== Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ===== */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  justify-content:center;
  align-items:center;
  z-index:500;
}

.modal-content{
  background:#111;
  padding:20px;
  border-radius:10px;
  width:90%;
  max-width:350px;
}
</style>
</head>

<body>

<div class="top-bar">
  <div class="balance">
    <span id="balance">0.00</span> ï·¼
  </div>

  <div class="user-menu">
    <div class="user-name" onclick="toggleMenu()">
      <span id="username">Ù…Ø³ØªØ®Ø¯Ù…</span> â–¼
    </div>
    <div class="dropdown" id="dropdown">
      <div onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
    </div>
  </div>
</div>

<div id="videos"></div>

<button class="add-btn" onclick="openAdd()">ï¼‹</button>

<div class="modal" id="addModal">
  <div class="modal-content">
    <h3>Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ</h3><br>
    <input id="videoUrl" placeholder="Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ MP4"><br><br>
    <button onclick="saveVideo()">Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, getDocs, addDoc,
  doc, getDoc, setDoc, updateDoc, deleteDoc,
  increment, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyB4tTVOD8P95EUzmOFNkco9AKI0wP1dLW0",
  authDomain: "salh01.firebaseapp.com",
  projectId: "salh01"
});

const auth = getAuth();
const db = getFirestore();

let currentUser;

/* ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ ===== */
onAuthStateChanged(auth, user=>{
  if(!user) return location.href="login.html";
  currentUser = user;

  username.innerText = user.email.split("@")[0];

  onSnapshot(doc(db,"users",user.uid), snap=>{
    if(snap.exists())
      balance.innerText = (snap.data().balance||0).toFixed(2);
  });

  loadVideos();
});

/* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ===== */
async function loadVideos(){
  const snap = await getDocs(collection(db,"videos"));
  videos.innerHTML="";

  snap.forEach(d=>{
    const v = d.data();

    const div = document.createElement("div");
    div.className="video";
    div.innerHTML=`
      <button class="delete-btn" onclick="deleteVideo('${d.id}')">Ø­Ø°Ù</button>

      <video
        src="${v.videoUrl}"
        muted
        autoplay
        playsinline
        preload="auto"
        controls
      ></video>

      <div class="reward-overlay">
        ğŸ‰<br>ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ 0.5 Ø±ÙŠØ§Ù„
      </div>
    `;

    const video = div.querySelector("video");
    const reward = div.querySelector(".reward-overlay");
    let rewarded = false;

    video.addEventListener("loadeddata", ()=>{
      video.play().catch(()=>{});
    });

    video.addEventListener("timeupdate", async ()=>{
      if(video.currentTime >= 10 && !rewarded){
        rewarded = true;

        const ref = doc(db,"interactions",`${currentUser.uid}_${d.id}`);
        const snap = await getDoc(ref);

        if(!snap.exists()){
          await setDoc(ref,{watched:true});
          await updateDoc(doc(db,"users",currentUser.uid),
            {balance:increment(0.5)});
          reward.style.display="flex";
        }
      }
    });

    observer.observe(video);
    videos.appendChild(div);
  });
}

/* ===== ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø¸Ù‡ÙˆØ± ===== */
const observer = new IntersectionObserver(entries=>{
  entries.forEach(e=>{
    const v = e.target;
    if(e.isIntersecting){
      v.play().catch(()=>{});
    }else{
      v.pause();
      v.currentTime = 0;
    }
  });
},{threshold:0.6});

/* ===== ÙˆØ¸Ø§Ø¦Ù Ø¹Ø§Ù…Ø© ===== */
window.deleteVideo = async(id)=>{
  if(!confirm("Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŸ")) return;
  await deleteDoc(doc(db,"videos",id));
  loadVideos();
};

window.openAdd = ()=> addModal.style.display="flex";

window.saveVideo = async()=>{
  const url = videoUrl.value.trim();
  if(!url.endsWith(".mp4")) return alert("ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ø§Ø¨Ø· mp4 Ù…Ø¨Ø§Ø´Ø±");
  await addDoc(collection(db,"videos"),{
    videoUrl:url,
    createdAt:Date.now()
  });
  addModal.style.display="none";
  loadVideos();
};

window.toggleMenu = ()=>{
  dropdown.style.display =
    dropdown.style.display==="block"?"none":"block";
};

window.logout = async()=>{
  await signOut(auth);
  location.href="login.html";
};
</script>

</body>
</html>
