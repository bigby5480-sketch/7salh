<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>

<script src="https://www.youtube.com/iframe_api"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  background:black;
  color:white;
  font-family:Arial;
  height:100vh;
  overflow-y:scroll;
  scroll-snap-type:y mandatory;
}

/* ===== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ===== */
.top-bar{
  position:fixed;
  top:0;
  right:0;
  left:0;
  height:55px;
  background:#111;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 15px;
  z-index:1000;
  border-bottom:1px solid #222;
}

.balance{
  color:#3f8efc;
  font-weight:bold;
}

.user-menu{ position:relative; }
.user-name{ cursor:pointer; display:flex; gap:6px; align-items:center; }
.arrow{ font-size:12px; opacity:.7; }

.dropdown{
  position:absolute;
  top:40px;
  left:0;
  background:#1a1a1a;
  border-radius:8px;
  display:none;
  min-width:160px;
}

.dropdown div{
  padding:10px;
  cursor:pointer;
}
.dropdown div:hover{ background:#333; }

/* ===== Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ===== */
#videos{ margin-top:55px; }

.video{
  height:100vh;
  scroll-snap-align:start;
  position:relative;
}

iframe{
  width:100%;
  height:100%;
  pointer-events:none;
  object-fit:contain;
  background:black;
}

.tap-layer{
  position:absolute;
  inset:0;
  z-index:5;
}

.delete-btn,.stats-btn{
  position:absolute;
  top:15px;
  z-index:9999;
  border:none;
  padding:6px 10px;
  border-radius:6px;
  cursor:pointer;
}

.delete-btn{
  left:15px;
  background:red;
  color:white;
}

.stats-btn{
  right:15px;
  background:#222;
  color:white;
  font-size:16px;
}

.reward-overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  z-index:30;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  cursor:pointer;
}

/* ===== Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ===== */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  justify-content:center;
  align-items:center;
  z-index:500;
}

.modal-content{
  background:#111;
  padding:20px;
  border-radius:10px;
  width:90%;
  max-width:350px;
}
</style>
</head>

<body>

<!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
<div class="top-bar">
  <div class="balance">
    <span id="balance">0.00</span> ï·¼
  </div>

  <div class="user-menu">
    <div class="user-name" onclick="toggleMenu()">
      <span id="username">Ù…Ø³ØªØ®Ø¯Ù…</span>
      <span class="arrow">â–¼</span>
    </div>
    <div class="dropdown" id="dropdown">
      <div onclick="goProfile()">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
      <div onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
    </div>
  </div>
</div>

<div id="videos"></div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
<div class="modal" id="chartModal">
  <div class="modal-content">
    <h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</h3>
    <canvas id="viewsChart"></canvas><br>
    <button onclick="closeChart()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, getDocs, addDoc,
  doc, getDoc, setDoc, updateDoc, deleteDoc,
  increment, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyB4tTVOD8P95EUzmOFNkco9AKI0wP1dLW0",
  authDomain:"salh01.firebaseapp.com",
  projectId:"salh01"
});

const auth=getAuth();
const db=getFirestore();

let players={}, currentUser, currentPlaying=null;
let chart;

onAuthStateChanged(auth,user=>{
  if(!user) return location.href="login.html";
  currentUser=user;

  username.innerText=user.displayName||user.email.split("@")[0];

  onSnapshot(doc(db,"users",user.uid),snap=>{
    if(snap.exists())
      balance.innerText=(snap.data().balance||0).toFixed(2);
  });

  loadVideos();
});

function waitForYT(cb){
  if(window.YT&&YT.Player) cb();
  else setTimeout(()=>waitForYT(cb),100);
}

function createPlayer(id,yt){
  players[id].player=new YT.Player(`player-${id}`,{
    videoId:yt,
    playerVars:{controls:0,rel:0,playsinline:1},
    events:{onStateChange:e=>handleState(e,id)}
  });
}

async function loadVideos(){
  const snap=await getDocs(collection(db,"videos"));
  videos.innerHTML="";

  snap.forEach(d=>{
    const v=d.data();
    const div=document.createElement("div");
    div.className="video";
    div.innerHTML=`
      <button class="delete-btn"
        onclick="event.stopPropagation();deleteVideo('${d.id}')">Ø­Ø°Ù</button>
      <button class="stats-btn"
        onclick="event.stopPropagation();showStats('${d.id}')">ğŸ“Š</button>

      <div id="player-${d.id}"></div>

      <div class="reward-overlay" id="reward-${d.id}"
        onclick="replay('${d.id}')">
        <span>ğŸ‰</span>
        <div>ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ 0.5 Ø±ÙŠØ§Ù„</div>
      </div>

      <div class="tap-layer" onclick="togglePlay('${d.id}')"></div>
    `;
    videos.appendChild(div);

    players[d.id]={youtubeId:v.youtubeId};
    waitForYT(()=>createPlayer(d.id,v.youtubeId));
  });

  observeVideos();
}

function togglePlay(id){
  const p=players[id].player;
  p.getPlayerState()===1?p.pauseVideo():p.playVideo();
}

async function showReward(id){
  const overlay=document.getElementById(`reward-${id}`);
  if(overlay.style.display==="flex") return;

  overlay.style.display="flex";

  const ref=doc(db,"interactions",`${currentUser.uid}_${id}`);
  const snap=await getDoc(ref);

  if(!snap.exists()){
    await setDoc(ref,{watched:true});
    await updateDoc(doc(db,"users",currentUser.uid),
      {balance:increment(0.5)});
  }
}

function replay(id){
  reward=document.getElementById(`reward-${id}`);
  reward.style.display="none";
  players[id].player.seekTo(0);
  players[id].player.playVideo();
}

function handleState(e,id){
  if(e.data===1){
    if(currentPlaying && currentPlaying!==id)
      players[currentPlaying].player.pauseVideo();
    currentPlaying=id;

    const p=players[id].player;
    const i=setInterval(async()=>{
      const d=p.getDuration(), c=p.getCurrentTime();
      if(d && c>=d-0.4){
        clearInterval(i);
        p.pauseVideo();
        showReward(id);
      }
    },300);
  }
}

function observeVideos(){
  const obs=new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      if(e.isIntersecting){
        const id=e.target.querySelector("[id^='player-']")
          .id.replace("player-","");
        if(currentPlaying!==id)
          players[id].player.playVideo();
      }
    });
  },{threshold:0.7});

  document.querySelectorAll(".video").forEach(v=>obs.observe(v));
}

window.deleteVideo=async id=>{
  if(!confirm("Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŸ")) return;
  await deleteDoc(doc(db,"videos",id));
  document.getElementById(`player-${id}`).closest(".video").remove();
};

window.showStats=async videoId=>{
  chartModal.style.display="flex";
  const snap=await getDocs(collection(db,"interactions"));
  let views=0;
  snap.forEach(d=>{
    if(d.id.endsWith("_"+videoId)) views++;
  });

  if(chart) chart.destroy();
  chart=new Chart(viewsChart,{
    type:"bar",
    data:{
      labels:["Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª"],
      datasets:[{data:[views],label:"Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª"}]
    }
  });
};

window.closeChart=()=>chartModal.style.display="none";

window.toggleMenu=()=>dropdown.style.display=
  dropdown.style.display==="block"?"none":"block";

window.logout=async()=>{
  await signOut(auth);
  location.href="login.html";
};

window.goProfile=()=>alert("Ø³ØªØ¶Ø§Ù Ù„Ø§Ø­Ù‚Ù‹Ø§");

document.addEventListener("click",e=>{
  if(!e.target.closest(".user-menu"))
    dropdown.style.display="none";
});
</script>
</body>
</html>
