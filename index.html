<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>

<script src="https://www.youtube.com/iframe_api"></script>

<style>
body{
  margin:0;
  background:black;
  color:white;
  font-family:Arial;
  height:100vh;
  overflow-y:scroll;
  scroll-snap-type:y mandatory;
}

.topbar{
  position:fixed;
  top:0;
  width:100%;
  height:55px;
  background:rgba(0,0,0,.85);
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 15px;
  z-index:1000;
}

#videos{
  margin-top:55px;
}

.video{
  height:100vh;
  scroll-snap-align:start;
  position:relative;
}

.player-wrap{
  position:absolute;
  inset:0;
}

iframe{
  width:100%;
  height:100%;
}

.controls{
  position:absolute;
  right:15px;
  bottom:120px;
  display:flex;
  flex-direction:column;
  gap:12px;
  z-index:10;
}

.controls button{
  background:rgba(0,0,0,.6);
  color:white;
  border:none;
  border-radius:50%;
  width:48px;
  height:48px;
  font-size:18px;
  cursor:pointer;
}

.add-btn{
  position:fixed;
  bottom:20px;
  right:20px;
  width:55px;
  height:55px;
  border-radius:50%;
  background:#3f8efc;
  color:white;
  font-size:32px;
  border:none;
  cursor:pointer;
  z-index:9999;
}

.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  justify-content:center;
  align-items:center;
  z-index:10000;
}

.modal-content{
  background:#111;
  padding:20px;
  border-radius:10px;
  width:90%;
  max-width:350px;
}
</style>
</head>

<body>

<div class="topbar">
  <div>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
</div>

<div id="videos"></div>

<button class="add-btn" onclick="openAdd()">ï¼‹</button>

<div class="modal" id="addModal">
  <div class="modal-content">
    <h3>Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ</h3><br>
    <input id="yt" placeholder="Ø±Ø§Ø¨Ø· YouTube" style="width:100%"><br><br>
    <button onclick="saveVideo()">Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, getDocs, addDoc, deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyB4tTVOD8P95EUzmOFNkco9AKI0wP1dLW0",
  authDomain: "salh01.firebaseapp.com",
  projectId: "salh01"
});

const auth = getAuth();
const db = getFirestore();

let players = {};
let observer;

onAuthStateChanged(auth, user=>{
  if(!user) location.href="login.html";
  loadVideos();
});

function waitYT(cb){
  if(window.YT && YT.Player) cb();
  else setTimeout(()=>waitYT(cb),100);
}

function createPlayer(id, ytId){
  players[id].player = new YT.Player(`player-${id}`,{
    videoId: ytId,
    playerVars:{
      controls:0,
      disablekb:1,
      rel:0,
      modestbranding:1,
      iv_load_policy:3
    }
  });
}

async function loadVideos(){
  const snap = await getDocs(collection(db,"videos"));
  videos.innerHTML="";
  players={};

  snap.forEach(d=>{
    const div=document.createElement("div");
    div.className="video";
    div.dataset.id=d.id;

    div.innerHTML=`
      <div class="player-wrap">
        <div id="player-${d.id}"></div>
      </div>
      <div class="controls">
        <button onclick="deleteVideo('${d.id}')">ğŸ—‘</button>
      </div>
    `;

    videos.appendChild(div);
    players[d.id]={};
    waitYT(()=>createPlayer(d.id,d.data().youtubeId));
  });

  initObserver();
}

function initObserver(){
  observer=new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      const id=e.target.dataset.id;
      const p=players[id]?.player;
      if(!p) return;

      if(e.isIntersecting && e.intersectionRatio>0.7){
        stopAll(id);
        p.playVideo();
      }else{
        p.pauseVideo();
      }
    });
  },{threshold:0.7});

  document.querySelectorAll(".video").forEach(v=>observer.observe(v));
}

function stopAll(except){
  Object.keys(players).forEach(id=>{
    if(id!==except && players[id].player)
      players[id].player.pauseVideo();
  });
}

window.openAdd=()=>{
  addModal.style.display="flex";
};

window.saveVideo=async()=>{
  const url=yt.value.trim();
  let id="";
  if(url.includes("watch?v=")) id=url.split("watch?v=")[1].split("&")[0];
  else if(url.includes("youtu.be/")) id=url.split("youtu.be/")[1].split("?")[0];
  if(!id) return alert("Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­");
  await addDoc(collection(db,"videos"),{youtubeId:id,createdAt:Date.now()});
  location.reload();
};

window.deleteVideo=async(id)=>{
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŸ")) return;
  await deleteDoc(doc(db,"videos",id));
  location.reload();
};
</script>

</body>
</html>
