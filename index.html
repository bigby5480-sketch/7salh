<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>

<style>
body{
  margin:0;
  background:black;
  color:white;
  font-family:Arial;
}

/* ===== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ===== */
.top-bar{
  position:fixed;
  top:0;
  right:0;
  left:0;
  height:55px;
  background:#111;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 15px;
  z-index:1000;
  border-bottom:1px solid #222;
}

.balance{
  color:#3f8efc;
  font-weight:bold;
}

.user{
  cursor:pointer;
}

.logout{
  position:absolute;
  top:55px;
  left:15px;
  background:#1a1a1a;
  padding:10px;
  border-radius:6px;
  display:none;
}

/* ===== Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ===== */
#videos{
  margin-top:55px;
}

.video{
  position:relative;
  height:300px;
}

.reward{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  justify-content:center;
  align-items:center;
  font-size:24px;
  z-index:999;
}

/* ===== Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© ===== */
.add-btn{
  position:fixed;
  bottom:20px;
  right:20px;
  width:55px;
  height:55px;
  border-radius:50%;
  background:#3f8efc;
  color:white;
  font-size:30px;
  border:none;
  cursor:pointer;
  z-index:500;
}

/* ===== Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ===== */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:600;
}
.modal-box{
  background:#111;
  padding:20px;
  border-radius:10px;
  width:90%;
  max-width:350px;
}
.modal-box input{
  width:100%;
  padding:10px;
}
.modal-box button{
  width:100%;
  padding:10px;
  margin-top:10px;
}
</style>
</head>

<body>

<!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
<div class="top-bar">
  <div class="balance">Ø§Ù„Ø±ØµÙŠØ¯: <span id="balance">0</span> ï·¼</div>
  <div class="user" onclick="toggleLogout()">
    <span id="username">Ù…Ø³ØªØ®Ø¯Ù…</span> â–¼
    <div class="logout" id="logoutBox" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
  </div>
</div>

<div id="videos"></div>

<div class="reward" id="reward">ğŸ‰ ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©</div>

<button class="add-btn" onclick="openModal()">ï¼‹</button>

<div class="modal" id="modal">
  <div class="modal-box">
    <input id="ytLink" placeholder="Ø§Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨">
    <button onclick="addVideo()">Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>
  </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  increment
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyB4tTVOD8P95EUzmOFNkco9AKI0wP1dLW0",
  authDomain: "salh01.firebaseapp.com",
  projectId: "salh01"
});

const auth = getAuth();
const db = getFirestore();

let user;
let index=0;
let players={}, state={};

onAuthStateChanged(auth,u=>{
  if(!u) location.href="login.html";
  user=u;
  username.innerText=u.email.split("@")[0];
});

/* ===== UI ===== */
window.openModal=()=> modal.style.display="flex";
window.toggleLogout=()=>{
  logoutBox.style.display =
    logoutBox.style.display==="block"?"none":"block";
};
window.logout=async()=>{
  await signOut(auth);
  location.href="login.html";
};

/* ===== Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ ===== */
window.addVideo = async()=>{
  const link=ytLink.value.trim();
  modal.style.display="none";
  ytLink.value="";

  const id=getId(link);
  if(!id) return alert("Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­");

  const key=id;
  const ref=doc(db,"watched",`${user.uid}_${key}`);
  if((await getDoc(ref)).exists())
    return alert("ØªÙ… Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø³Ø§Ø¨Ù‚Ù‹Ø§");

  const pid="p"+(++index);
  state[pid]={played:false,last:0,key};

  const div=document.createElement("div");
  div.className="video";
  div.innerHTML=`<div id="${pid}"></div>`;
  videos.prepend(div);

  players[pid]=new YT.Player(pid,{
    videoId:id,
    playerVars:{playsinline:1,disablekb:1},
    events:{onStateChange:e=>onState(e,pid)}
  });
};

/* ===== Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ù…ÙƒØ§ÙØ£Ø© ===== */
function onState(e,pid){
  const p=players[pid];
  const s=state[pid];

  if(e.data===YT.PlayerState.PLAYING){
    if(!s.played){
      s.played=true;
      s.last=p.getCurrentTime();
      s.timer=setInterval(()=>{
        const t=p.getCurrentTime();
        if(t>s.last+1.2) p.seekTo(s.last,true);
        else s.last=t;
      },500);
    }
  }

  if(e.data===YT.PlayerState.ENDED){
    clearInterval(s.timer);
    rewardVideo(s.key);
  }
}

async function rewardVideo(key){
  const ref=doc(db,"watched",`${user.uid}_${key}`);
  if((await getDoc(ref)).exists()) return;

  await setDoc(ref,{done:true});
  await updateDoc(doc(db,"users",user.uid),{
    balance:increment(0.5)
  });

  reward.style.display="flex";
}

/* ===== Ø§Ø³ØªØ®Ø±Ø§Ø¬ ID ===== */
function getId(url){
  try{
    const u=new URL(url);
    if(u.hostname.includes("youtu.be"))
      return u.pathname.slice(1);
    return u.searchParams.get("v");
  }catch{
    return null;
  }
}
</script>

</body>
</html>
