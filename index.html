<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</title>

<script src="https://www.youtube.com/iframe_api"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  height: 100vh;
  overflow-y: scroll;
  scroll-snap-type: y mandatory;
  background: black;
}

.video {
  height: 100vh;
  scroll-snap-align: start;
  position: relative;
}

iframe {
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.controls {
  position: absolute;
  right: 15px;
  bottom: 120px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.controls button {
  background: rgba(0,0,0,.6);
  color: white;
  border: none;
  padding: 10px;
  border-radius: 50%;
  cursor: pointer;
}

.controls button.active {
  background: #3f8efc;
}

/* MODALS */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  justify-content: center;
  align-items: center;
  z-index: 999;
}

.modal-content {
  background: white;
  padding: 20px;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
}
</style>
</head>

<body>

<div id="container"></div>

<!-- Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ (Ù…Ø´Ø±Ù) -->
<div id="addModal" class="modal">
  <div class="modal-content">
    <h3>Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ</h3>
    <input id="ytId" placeholder="YouTube ID">
    <input id="order" placeholder="Ø§Ù„ØªØ±ØªÙŠØ¨" type="number">
    <button onclick="addVideo()">Ø¥Ø¶Ø§ÙØ©</button>
  </div>
</div>

<!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
<div id="statsModal" class="modal">
  <div class="modal-content">
    <canvas id="statsChart"></canvas>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, getDocs, orderBy, query,
  doc, getDoc, setDoc, updateDoc, increment, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB4tTVOD8P95EUzmOFNkco9AKI0wP1dLW0",
  authDomain: "salh01.firebaseapp.com",
  projectId: "salh01",
  storageBucket: "salh01.firebasestorage.app",
  messagingSenderId: "300533907694",
  appId: "1:300533907694:web:2d4687cb5f32ead32133ff"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser, isAdmin = false;
let players = [];

onAuthStateChanged(auth, async user => {
  if (!user) return location.href = "login.html";
  currentUser = user;

  const u = await getDoc(doc(db, "users", user.uid));
  isAdmin = u.data().role === "admin";

  loadVideos();
});

async function loadVideos() {
  const q = query(collection(db, "videos"), orderBy("order"));
  const snap = await getDocs(q);

  snap.forEach(docSnap => {
    const v = docSnap.data();
    const vid = docSnap.id;

    const el = document.createElement("div");
    el.className = "video";

    el.innerHTML = `
      <div id="player-${vid}"></div>
      <div class="controls">
        <button id="like-${vid}">â˜…</button>
        <button id="watched-${vid}">âœ”</button>
        ${isAdmin ? `<button onclick="showStats('${vid}')">ğŸ“Š</button>
        <button onclick="deleteVideo('${vid}')">ğŸ—‘</button>` : ``}
      </div>
    `;

    container.appendChild(el);
    players.push({ id: vid, youtubeId: v.youtubeId });
    setupButtons(vid);
  });
}

window.onYouTubeIframeAPIReady = () => {
  players.forEach(p => {
    new YT.Player(`player-${p.id}`, {
      videoId: p.youtubeId,
      playerVars: { controls: 0 },
      events: {
        onStateChange: e => handleEnd(e, p.id)
      }
    });
  });
};

async function handleEnd(e, videoId) {
  if (e.data === 0) {
    const ref = doc(db, "interactions", `${currentUser.uid}_${videoId}`);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      await setDoc(ref, { watched: true });
      await updateDoc(doc(db, "users", currentUser.uid), { balance: increment(0.5) });
      await updateDoc(doc(db, "videos", videoId), { totalViews: increment(1) });
    }
    document.getElementById(`watched-${videoId}`).classList.add("active");
  }
}

async function setupButtons(videoId) {
  const ref = doc(db, "interactions", `${currentUser.uid}_${videoId}`);
  const snap = await getDoc(ref);

  const like = document.getElementById(`like-${videoId}`);
  if (snap.exists() && snap.data().liked) like.classList.add("active");

  like.onclick = async () => {
    await setDoc(ref, { liked: true }, { merge: true });
    like.classList.add("active");
  };
}

window.deleteVideo = async id => {
  await deleteDoc(doc(db, "videos", id));
  location.reload();
};

window.showStats = async videoId => {
  const q = query(collection(db, "interactions"));
  const snap = await getDocs(q);

  const ageStats = {};
  for (const d of snap.docs) {
    if (d.id.includes(videoId) && d.data().watched) {
      const u = await getDoc(doc(db, "users", d.id.split("_")[0]));
      const age = u.data().age;
      ageStats[age] = (ageStats[age] || 0) + 1;
    }
  }

  document.getElementById("statsModal").style.display = "flex";

  new Chart(statsChart, {
    type: "pie",
    data: {
      labels: Object.keys(ageStats),
      datasets: [{ data: Object.values(ageStats) }]
    }
  });
};
</script>

</body>
</html>
