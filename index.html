<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>

<style>
body{
  margin:0;
  background:black;
  color:white;
  font-family:Arial;
  height:100vh;
  overflow-y:scroll;
  scroll-snap-type:y mandatory;
}

/* ===== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ===== */
.top-bar{
  position:fixed;
  top:0;
  right:0;
  left:0;
  height:55px;
  background:#111;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 15px;
  z-index:1000;
  border-bottom:1px solid #222;
}

.balance{
  font-size:16px;
  font-weight:bold;
  color:#3f8efc;
}

.user-menu{ position:relative; }

.user-name{
  cursor:pointer;
}

.dropdown{
  position:absolute;
  top:40px;
  left:0;
  background:#1a1a1a;
  border-radius:8px;
  display:none;
  min-width:160px;
}

.dropdown div{
  padding:10px;
  cursor:pointer;
}
.dropdown div:hover{ background:#333; }

/* ===== Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ===== */
#videos{ margin-top:55px; }

.video{
  height:100vh;
  position:relative;
  scroll-snap-align:start;
}

video{
  width:100%;
  height:100%;
  object-fit:cover;
  pointer-events:none; /* Ù…Ù†Ø¹ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… ÙˆØ§Ù„ØªØ£Ø®ÙŠØ± */
}

/* ===== Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© ===== */
.reward{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.75);
  display:none;
  z-index:5;
  justify-content:center;
  align-items:center;
  font-size:26px;
  cursor:pointer;
}

/* ===== Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© ===== */
.add-btn{
  position:fixed;
  bottom:20px;
  right:20px;
  width:55px;
  height:55px;
  border-radius:50%;
  background:#3f8efc;
  color:white;
  font-size:30px;
  border:none;
  z-index:100;
  cursor:pointer;
}

/* ===== Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ===== */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:200;
}

.modal-content{
  background:#111;
  padding:20px;
  border-radius:10px;
  width:90%;
  max-width:350px;
}
</style>
</head>

<body>

<div class="top-bar">
  <div class="balance">
    <span id="balance">0.00</span> ï·¼
  </div>

  <div class="user-menu">
    <div class="user-name" onclick="toggleMenu()">Ù…Ø³ØªØ®Ø¯Ù… â–¼</div>
    <div class="dropdown" id="dropdown">
      <div onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
    </div>
  </div>
</div>

<div id="videos"></div>

<button class="add-btn" onclick="openAdd()">ï¼‹</button>

<div class="modal" id="addModal">
  <div class="modal-content">
    <h3>Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ</h3><br>
    <input id="videoUrl" placeholder="Ø±Ø§Ø¨Ø· MP4 Ù…Ø¨Ø§Ø´Ø±"><br><br>
    <button onclick="saveVideo()">Ø­ÙØ¸</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, getDocs,
  doc, getDoc, setDoc, updateDoc,
  increment, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyB4tTVOD8P95EUzmOFNkco9AKI0wP1dLW0",
  authDomain: "salh01.firebaseapp.com",
  projectId: "salh01"
});

const auth = getAuth();
const db = getFirestore();

let currentUser;

/* ===== Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ===== */
onAuthStateChanged(auth, user=>{
  if(!user) location.href="login.html";
  currentUser = user;

  onSnapshot(doc(db,"users",user.uid), snap=>{
    if(snap.exists())
      balance.innerText = (snap.data().balance||0).toFixed(2);
  });

  loadVideos();
});

/* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ===== */
async function loadVideos(){
  videos.innerHTML="";
  const snap = await getDocs(collection(db,"videos"));

  snap.forEach(d=>{
    const data = d.data();

    const div = document.createElement("div");
    div.className="video";

    div.innerHTML=`
      <video muted playsinline>
        <source src="${data.videoUrl}" type="video/mp4">
      </video>
      <div class="reward">ğŸ‰ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ 0.5 Ø±ÙŠØ§Ù„</div>
    `;

    const video = div.querySelector("video");
    const reward = div.querySelector(".reward");
    let finished = false;

    div.addEventListener("click", ()=>{
      if(video.paused){
        video.play().catch(()=>{});
      }
    });

    video.addEventListener("ended", async ()=>{
      reward.style.display="flex";

      const ref = doc(db,"interactions",
        currentUser.uid + "_" + d.id);

      const seen = await getDoc(ref);
      if(!seen.exists()){
        await setDoc(ref,{done:true});
        await updateDoc(
          doc(db,"users",currentUser.uid),
          {balance: increment(0.5)}
        );
      }
    });

    reward.addEventListener("click", e=>{
      e.stopPropagation();
      reward.style.display="none";
      video.currentTime = 0;
      video.play();
    });

    videos.appendChild(div);
  });
}

/* ===== Ø§Ù„Ø¥Ø¶Ø§ÙØ© ===== */
window.openAdd = ()=> addModal.style.display="flex";

window.saveVideo = async()=>{
  const url = videoUrl.value.trim();
  if(!url.endsWith(".mp4"))
    return alert("Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† mp4 Ù…Ø¨Ø§Ø´Ø±");

  await addDoc(collection(db,"videos"),{
    videoUrl:url,
    createdAt:Date.now()
  });

  addModal.style.display="none";
  videoUrl.value="";
  loadVideos();
};

/* ===== Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ===== */
window.toggleMenu = ()=>{
  dropdown.style.display =
    dropdown.style.display==="block"?"none":"block";
};

window.logout = async()=>{
  await signOut(auth);
  location.href="login.html";
};
</script>

</body>
</html>
