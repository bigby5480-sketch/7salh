<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
<script src="https://www.youtube.com/iframe_api"></script>

<style>
body{
  margin:0;
  background:black;
  color:white;
  font-family:Arial;
  height:100vh;
  overflow-y:scroll;
  scroll-snap-type:y mandatory;
}

/* ===== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ===== */
.top-bar{
  position:fixed;
  top:0;
  right:0;
  left:0;
  height:55px;
  background:#111;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 15px;
  z-index:1000;
  border-bottom:1px solid #222;
}

.balance{
  font-size:16px;
  font-weight:bold;
  color:#3f8efc;
}

.balance .sar{
  margin-right:4px;
}

.user-menu{
  position:relative;
}

.user-name{
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:6px;
}

.arrow{
  font-size:12px;
  opacity:.7;
}

.dropdown{
  position:absolute;
  top:40px;
  left:0;
  background:#1a1a1a;
  border-radius:8px;
  overflow:hidden;
  display:none;
  min-width:160px;
  box-shadow:0 5px 20px rgba(0,0,0,.5);
}

.dropdown div{
  padding:10px;
  cursor:pointer;
}

.dropdown div:hover{
  background:#333;
}

/* ===== Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ===== */
#videos{ margin-top:55px; }

.video{
  height:100vh;
  scroll-snap-align:start;
  position:relative;
}

iframe{
  width:100%;
  height:100%;
  pointer-events:auto; /* âœ… ØªØ¹Ø¯ÙŠÙ„ */
}

.tap-layer{
  position:absolute;
  inset:0;
  z-index:5;
}

.add-btn{
  position:fixed;
  bottom:20px;
  right:20px;
  width:55px;
  height:55px;
  border-radius:50%;
  background:#3f8efc;
  color:white;
  font-size:30px;
  border:none;
  z-index:100;
  cursor:pointer;
}

.delete-btn{
  position:absolute;
  top:15px;
  left:15px;
  z-index:9999;
  background:red;
  color:white;
  border:none;
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
}

.reward-overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.85);
  z-index:30;
  display:none;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  cursor:pointer;
}

.reward-overlay span{
  font-size:36px;
}

.yt-end-cover{
  position:absolute;
  bottom:0;
  left:0;
  width:100%;
  height:40%;
  background:black;
  z-index:20;
}

/* ===== Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ===== */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  justify-content:center;
  align-items:center;
  z-index:500;
}

.modal-content{
  background:#111;
  padding:20px;
  border-radius:10px;
  width:90%;
  max-width:350px;
}
</style>
</head>

<body>

<!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
<div class="top-bar">
  <div class="balance">
    <span id="balance">0.00</span> <span class="sar">ï·¼</span>
  </div>

  <div class="user-menu">
    <div class="user-name" onclick="toggleMenu()">
      <span id="username">Ù…Ø³ØªØ®Ø¯Ù…</span>
      <span class="arrow">â–¼</span>
    </div>

    <div class="dropdown" id="dropdown">
      <div onclick="goProfile()">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
      <div onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
    </div>
  </div>
</div>

<div id="videos"></div>

<button class="add-btn" onclick="openAdd()">ï¼‹</button>

<div class="modal" id="addModal">
  <div class="modal-content">
    <h3>Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ</h3><br>
    <input id="yt" placeholder="Ø±Ø§Ø¨Ø· YouTube"><br><br>
    <button onclick="saveVideo()">Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, getDocs, addDoc,
  doc, getDoc, setDoc, updateDoc, deleteDoc,
  increment, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyB4tTVOD8P95EUzmOFNkco9AKI0wP1dLW0",
  authDomain: "salh01.firebaseapp.com",
  projectId: "salh01"
});

const auth = getAuth();
const db = getFirestore();

let players={}, currentUser, currentPlaying=null;

onAuthStateChanged(auth, user=>{
  if(!user) return location.href="login.html";
  currentUser=user;

  document.getElementById("username").innerText =
    user.displayName || user.email.split("@")[0];

  onSnapshot(doc(db,"users",user.uid), snap=>{
    if(snap.exists()){
      document.getElementById("balance").innerText =
        (snap.data().balance || 0).toFixed(2);
    }
  });

  loadVideos();
});

function waitForYT(cb){
  if(window.YT && YT.Player) cb();
  else setTimeout(()=>waitForYT(cb),100);
}

function createPlayer(id,yt){
  players[id].player=new YT.Player(`player-${id}`,{
    videoId:yt,
    playerVars:{
      controls:1, /* âœ… ØªØ¹Ø¯ÙŠÙ„ */
      rel:0,
      playsinline:1
    },
    events:{onStateChange:e=>handleState(e,id)}
  });
}

async function loadVideos(){
  const snap=await getDocs(collection(db,"videos"));
  const c=document.getElementById("videos");
  c.innerHTML="";

  snap.forEach(d=>{
    const v=d.data();
    const div=document.createElement("div");
    div.className="video";
    div.innerHTML=`
      <button class="delete-btn"
        onclick="event.stopPropagation(); deleteVideo('${d.id}')">Ø­Ø°Ù</button>
      <div id="player-${d.id}"></div>
      <div class="yt-end-cover"></div>
      <div class="reward-overlay" id="reward-${d.id}"
        onclick="replay('${d.id}')">
        <span>ğŸ‰</span>
        <div>ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ 0.5 Ø±ÙŠØ§Ù„</div>
      </div>
      <div class="tap-layer" onclick="togglePlay('${d.id}')"></div>
    `;
    c.appendChild(div);

    players[d.id]={youtubeId:v.youtubeId};
    waitForYT(()=>createPlayer(d.id,v.youtubeId));
  });

  observeVideos();
}

function togglePlay(id){
  const p=players[id].player;
  p.getPlayerState()===1?p.pauseVideo():p.playVideo();
}

function replay(id){
  document.getElementById(`reward-${id}`).style.display="none";
  players[id].player.seekTo(0);
  players[id].player.playVideo();
}

async function handleState(e,id){
  if(e.data===1){
    if(currentPlaying && currentPlaying!==id)
      players[currentPlaying].player.pauseVideo();
    currentPlaying=id;
  }

  if(e.data===0){
    const ref=doc(db,"interactions",`${currentUser.uid}_${id}`);
    const snap=await getDoc(ref);

    if(!snap.exists()){
      await setDoc(ref,{watched:true});
      await updateDoc(doc(db,"users",currentUser.uid),
        {balance:increment(0.5)});
    }

    document.getElementById(`reward-${id}`).style.display="flex";
  }
}

function observeVideos(){
  const obs=new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      if(e.isIntersecting){
        const id=e.target.querySelector("[id^='player-']")
          .id.replace("player-","");
        if(currentPlaying!==id)
          players[id].player.playVideo();
      }
    });
  },{threshold:0.7});

  document.querySelectorAll(".video").forEach(v=>obs.observe(v));
}

window.deleteVideo=async(id)=>{
  if(!confirm("Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŸ")) return;
  await deleteDoc(doc(db,"videos",id));
  document.getElementById(`player-${id}`).closest(".video").remove();
  delete players[id];
};

window.openAdd=()=>addModal.style.display="flex";

window.saveVideo=async()=>{
  const url=yt.value.trim();
  let id="";
  if(url.includes("watch?v=")) id=url.split("watch?v=")[1].split("&")[0];
  else if(url.includes("youtu.be/")) id=url.split("youtu.be/")[1];
  if(!id) return alert("Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­");
  await addDoc(collection(db,"videos"),{youtubeId:id,createdAt:Date.now()});
  location.reload();
};

window.toggleMenu=()=>{
  dropdown.style.display =
    dropdown.style.display==="block"?"none":"block";
};

window.logout=async()=>{
  await signOut(auth);
  location.href="login.html";
};

window.goProfile=()=>alert("Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§");

document.addEventListener("click",e=>{
  if(!e.target.closest(".user-menu"))
    dropdown.style.display="none";
});
</script>
</body>
</html>
