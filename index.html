<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
<script src="https://www.youtube.com/iframe_api"></script>

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:Arial;
}

/* ===== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ===== */
.top-bar{
  position:fixed;
  top:0; left:0; right:0;
  height:55px;
  background:#111;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 15px;
  z-index:1000;
}

.balance{ color:#3f8efc; font-weight:bold; }

/* ===== Ø´Ø¨ÙƒØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ===== */
#videos{
  margin-top:65px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
  gap:15px;
  padding:15px;
}

.video-box{
  position:relative;
  background:#111;
  border-radius:10px;
  overflow:hidden;
  cursor:pointer;
  aspect-ratio:9/16;
}

.video-box iframe{
  width:100%;
  height:100%;
  pointer-events:none;
}

/* ===== Ø´Ø§Ø±Ø© Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© ===== */
.done-badge{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.75);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  text-align:center;
  padding:10px;
  z-index:5;
}

/* ===== Ø²Ø± Ø§Ù„Ø­Ø°Ù ===== */
.delete-btn{
  position:absolute;
  top:5px;
  left:5px;
  background:red;
  color:white;
  border:none;
  border-radius:50%;
  width:28px;
  height:28px;
  cursor:pointer;
  z-index:10;
}

/* ===== Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ (ÙƒØ§Ù…Ù„ Ø§Ù„Ø´Ø§Ø´Ø©) ===== */
#playerModal{
  position:fixed;
  inset:0;
  background:black;
  display:none;
  z-index:2000;
}

#closePlayer{
  position:absolute;
  top:10px;
  left:10px;
  font-size:26px;
  cursor:pointer;
  z-index:10;
}

#playerContainer{
  width:100vw;
  height:100vh;
}
#playerContainer iframe{
  width:100vw !important;
  height:100vh !important;
}
</style>
</head>

<body>

<div class="top-bar">
  <div class="balance"><span id="balance">0.00</span> ï·¼</div>
</div>

<div id="videos"></div>

<!-- Ø§Ù„Ù…Ø´ØºÙ„ -->
<div id="playerModal">
  <div id="closePlayer" onclick="closePlayer()">âœ–</div>
  <div id="playerContainer"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, getDocs, doc, getDoc,
  deleteDoc, updateDoc, increment, setDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyB4tTVOD8P95EUzmOFNkco9AKI0wP1dLW0",
  authDomain:"salh01.firebaseapp.com",
  projectId:"salh01"
});

const auth = getAuth();
const db = getFirestore();

let currentUser;
let player;
let currentVideoId;
let cheated = false;
let startedAt = null;

onAuthStateChanged(auth,user=>{
  if(!user) location.href="login.html";
  currentUser = user;

  onSnapshot(doc(db,"users",user.uid), snap=>{
    if(snap.exists())
      balance.innerText = (snap.data().balance||0).toFixed(2);
  });

  loadVideos();
});

/* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ===== */
async function loadVideos(){
  videos.innerHTML="";
  const snap = await getDocs(collection(db,"videos"));

  for(const d of snap.docs){
    const data = d.data();
    const seenRef = doc(db,"interactions", currentUser.uid+"_"+d.id);
    const seenSnap = await getDoc(seenRef);

    const box = document.createElement("div");
    box.className="video-box";

    box.innerHTML=`
      <button class="delete-btn">âœ–</button>
      <iframe src="https://www.youtube.com/embed/${data.youtubeId}?controls=0"></iframe>
      ${seenSnap.exists()
        ?'<div class="done-badge">ğŸ‰ ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©<br>0.5 Ø±ÙŠØ§Ù„</div>'
        :''}
    `;

    box.onclick = ()=> openPlayer(data.youtubeId, d.id, seenSnap.exists());

    box.querySelector(".delete-btn").onclick = async e=>{
      e.stopPropagation();
      if(confirm("Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŸ")){
        await deleteDoc(doc(db,"videos",d.id));
        loadVideos();
      }
    };

    videos.appendChild(box);
  }
}

/* ===== Ø§Ù„Ù…Ø´ØºÙ„ ===== */
window.openPlayer = async (ytId, vid, alreadySeen)=>{
  currentVideoId = vid;
  cheated = false;
  startedAt = null;

  playerModal.style.display="block";
  playerContainer.innerHTML='<div id="player"></div>';

  player = new YT.Player("player",{
    videoId:ytId,
    playerVars:{
      controls:0,
      disablekb:1,
      playsinline:1,
      modestbranding:1
    },
    events:{
      onStateChange: async e=>{
        if(e.data === YT.PlayerState.PLAYING){
          if(startedAt === null){
            startedAt = player.getCurrentTime();
          }else{
            if(Math.abs(player.getCurrentTime()-startedAt)>1)
              cheated = true;
          }
        }

        if(e.data === YT.PlayerState.ENDED){
          if(!cheated && !alreadySeen){
            await setDoc(
              doc(db,"interactions", currentUser.uid+"_"+vid),
              {done:true}
            );
            await updateDoc(
              doc(db,"users",currentUser.uid),
              {balance:increment(0.5)}
            );
          }
          closePlayer();
          loadVideos();
        }
      }
    }
  });
};

window.closePlayer = ()=>{
  if(player) player.destroy();
  playerModal.style.display="none";
};
</script>

</body>
</html>
