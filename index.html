<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>

<script src="https://www.youtube.com/iframe_api"></script>

<style>
body{
  margin:0;
  background:black;
  color:white;
  font-family:Arial;
  height:100vh;
  overflow-y:scroll;
  scroll-snap-type:y mandatory;
}

.topbar{
  position:fixed;
  top:0;
  width:100%;
  height:55px;
  background:rgba(0,0,0,.85);
  display:flex;
  align-items:center;
  padding:0 15px;
  z-index:1000;
}

.video{
  height:100vh;
  scroll-snap-align:start;
  position:relative;
  margin-top:55px;
}

iframe{width:100%;height:100%}

.tap-layer{
  position:absolute;
  inset:0;
  z-index:10;
}

.yt-title-cover{
  position:absolute;
  top:0;
  width:100%;
  height:65px;
  background:black;
  z-index:11;
  pointer-events:none;
}

.yt-end-cover{
  position:absolute;
  bottom:0;
  width:100%;
  height:160px;
  background:black;
  z-index:11;
  pointer-events:none;
}

.reward-overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.85);
  z-index:20;
  display:none;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  cursor:pointer;
  font-size:22px;
}

.reward-overlay span{font-size:40px}

.add-btn{
  position:fixed;
  bottom:20px;
  right:20px;
  width:55px;
  height:55px;
  border-radius:50%;
  background:#3f8efc;
  color:white;
  font-size:32px;
  border:none;
  cursor:pointer;
  z-index:2000;
}

.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  justify-content:center;
  align-items:center;
  z-index:3000;
}

.modal-content{
  background:#111;
  padding:20px;
  border-radius:10px;
  width:90%;
  max-width:350px;
}
</style>
</head>

<body>

<div class="topbar">
  <div id="balance">0 ï·¼</div>
</div>

<div id="videos"></div>

<button class="add-btn" onclick="openAdd()">ï¼‹</button>

<div class="modal" id="addModal">
  <div class="modal-content">
    <h3>Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ</h3><br>
    <input id="yt" placeholder="Ø±Ø§Ø¨Ø· YouTube"><br><br>
    <button onclick="saveVideo()">Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, doc, getDoc, collection, getDocs,
  addDoc, setDoc, updateDoc, increment
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyB4tTVOD8P95EUzmOFNkco9AKI0wP1dLW0",
  authDomain:"salh01.firebaseapp.com",
  projectId:"salh01"
});

const auth=getAuth();
const db=getFirestore();

let players={}, currentUser, userData, observer, currentPlaying=null;
let userInteracted=false;

onAuthStateChanged(auth, async user=>{
  if(!user) location.href="login.html";
  currentUser=user;
  const snap=await getDoc(doc(db,"users",user.uid));
  userData=snap.data();
  balance.innerText=userData.balance+" ï·¼";
  loadVideos();
});

function waitYT(cb){
  if(window.YT && YT.Player) cb();
  else setTimeout(()=>waitYT(cb),100);
}

function createPlayer(id,yt){
  players[id].player=new YT.Player(`player-${id}`,{
    videoId:yt,
    playerVars:{
      controls:0,
      rel:0,
      modestbranding:1,
      playsinline:1,
      iv_load_policy:3
    },
    events:{
      onReady:e=>e.target.mute(),
      onStateChange:e=>handleState(e,id)
    }
  });
}

observer=new IntersectionObserver(entries=>{
  entries.forEach(entry=>{
    const id=entry.target.dataset.id;
    const p=players[id]?.player;
    if(!p) return;

    if(entry.isIntersecting){
      if(currentPlaying && currentPlaying!==id)
        players[currentPlaying].player.pauseVideo();

      p.playVideo();
      currentPlaying=id;
    }else{
      p.pauseVideo();
    }
  });
},{threshold:0.7});

async function loadVideos(){
  const snap=await getDocs(collection(db,"videos"));
  videos.innerHTML="";

  snap.forEach(d=>{
    const div=document.createElement("div");
    div.className="video";
    div.dataset.id=d.id;

    div.innerHTML=`
      <div class="yt-title-cover"></div>
      <div id="player-${d.id}"></div>
      <div class="yt-end-cover"></div>

      <div class="reward-overlay" id="reward-${d.id}"
        onclick="replayVideo('${d.id}')">
        <span>ğŸ‰ğŸ‘</span>
        <div>ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ <b>0.5 Ø±ÙŠØ§Ù„</b></div>
        <small>Ø§Ø³ØªÙ…Ø± Ø¨Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ù„Ø²ÙŠØ§Ø¯Ø© Ø£Ø±Ø¨Ø§Ø­Ùƒ</small>
      </div>

      <div class="tap-layer" onclick="togglePlay('${d.id}')"></div>
    `;

    videos.appendChild(div);
    observer.observe(div);

    players[d.id]={};
    waitYT(()=>createPlayer(d.id,d.data().youtubeId));

    checkReward(d.id);
  });
}

async function checkReward(id){
  const ref=doc(db,"interactions",`${currentUser.uid}_${id}`);
  const snap=await getDoc(ref);
  if(snap.exists())
    document.getElementById(`reward-${id}`).style.display="flex";
}

function togglePlay(id){
  userInteracted=true;
  const p=players[id].player;
  p.unMute();
  p.getPlayerState()===YT.PlayerState.PLAYING ? p.pauseVideo() : p.playVideo();
}

window.replayVideo=id=>{
  const p=players[id].player;
  p.seekTo(0);
  p.playVideo();
};

async function handleState(e,id){
  if(e.data===YT.PlayerState.ENDED){
    const ref=doc(db,"interactions",`${currentUser.uid}_${id}`);
    const snap=await getDoc(ref);

    if(!snap.exists()){
      await setDoc(ref,{watched:true});
      await updateDoc(doc(db,"users",currentUser.uid),{
        balance:increment(0.5)
      });
      userData.balance+=0.5;
      balance.innerText=userData.balance+" ï·¼";
    }

    document.getElementById(`reward-${id}`).style.display="flex";
  }
}

window.openAdd=()=>addModal.style.display="flex";

window.saveVideo=async()=>{
  const url=yt.value.trim();
  let id="";
  if(url.includes("watch?v=")) id=url.split("watch?v=")[1].split("&")[0];
  else if(url.includes("youtu.be/")) id=url.split("youtu.be/")[1].split("?")[0];
  if(!id) return alert("Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­");
  await addDoc(collection(db,"videos"),{youtubeId:id});
  location.reload();
};
</script>

</body>
</html>
