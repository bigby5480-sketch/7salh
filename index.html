<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>الرئيسية</title>

<script src="https://www.youtube.com/iframe_api"></script>

<style>
body{
  margin:0;
  background:black;
  color:white;
  font-family:Arial;
  height:100vh;
  overflow-y:scroll;
  scroll-snap-type:y mandatory;
}
.topbar{
  position:fixed;
  top:0;
  width:100%;
  height:55px;
  background:rgba(0,0,0,.85);
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 15px;
  z-index:1000;
}
.balance{font-size:16px}
.dots{font-size:28px;cursor:pointer}
.dropdown{
  position:absolute;
  top:55px;
  right:10px;
  background:#1e1e1e;
  border-radius:10px;
  display:none;
  flex-direction:column;
  min-width:180px;
}
.dropdown div,.dropdown button{
  padding:12px;
  color:white;
  background:none;
  border:none;
  text-align:right;
}

.video{
  height:calc(100vh - 55px);
  margin-top:55px;
  scroll-snap-align:start;
  position:relative;
}

.player-wrap{
  position:absolute;
  inset:0;
  z-index:1;
}

iframe{
  width:100%;
  height:100%;
  pointer-events:auto;
}

.controls{
  position:absolute;
  right:15px;
  bottom:120px;
  display:flex;
  flex-direction:column;
  gap:12px;
  z-index:5;
}
.controls button{
  background:rgba(0,0,0,.6);
  color:white;
  border:none;
  border-radius:50%;
  width:48px;
  height:48px;
  font-size:18px;
}
.controls button.active{background:#3f8efc}

.add-btn{
  position:fixed;
  bottom:20px;
  right:20px;
  width:55px;
  height:55px;
  border-radius:50%;
  background:#3f8efc;
  color:white;
  font-size:32px;
  border:none;
  cursor:pointer;
  z-index:1500;
}

.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  justify-content:center;
  align-items:center;
  z-index:2000;
}
.modal-content{
  background:#111;
  padding:20px;
  border-radius:10px;
  width:90%;
  max-width:350px;
}
</style>
</head>

<body>

<div class="topbar">
  <div class="balance" id="balance">0 ﷼</div>
  <div class="dots" onclick="toggleMenu()">⋯</div>
  <div class="dropdown" id="dropdown">
    <div id="username"></div>
    <button onclick="alert('لاحقًا')">معلومات المستخدم</button>
    <button onclick="logout()">تسجيل الخروج</button>
  </div>
</div>

<div id="videos"></div>

<button class="add-btn" onclick="openAdd()">＋</button>

<div class="modal" id="addModal">
  <div class="modal-content">
    <h3>إضافة فيديو</h3><br>
    <input id="yt" placeholder="رابط YouTube"><br><br>
    <button onclick="saveVideo()">حفظ الفيديو</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, doc, getDoc, collection, getDocs,
  addDoc, setDoc, updateDoc, increment
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyB4tTVOD8P95EUzmOFNkco9AKI0wP1dLW0",
  authDomain: "salh01.firebaseapp.com",
  projectId: "salh01"
});

const auth = getAuth();
const db = getFirestore();

let currentUser, userData;
let players = {};
let currentPlaying = null;

onAuthStateChanged(auth, async user => {
  if (!user) location.href = "login.html";
  currentUser = user;
  const snap = await getDoc(doc(db, "users", user.uid));
  userData = snap.data();
  username.innerText = userData.name;
  balance.innerText = userData.balance + " ﷼";
  loadVideos();
});

function waitForYT(cb){
  if(window.YT && YT.Player) cb();
  else setTimeout(()=>waitForYT(cb),100);
}

function createPlayer(id, ytId){
  players[id].player = new YT.Player(`player-${id}`,{
    videoId: ytId,
    playerVars:{controls:0,disablekb:1},
    events:{onStateChange:e=>handleState(e,id)}
  });
}

async function loadVideos(){
  const snap = await getDocs(collection(db,"videos"));
  videos.innerHTML = "";

  snap.forEach(d=>{
    const v = d.data();
    const div = document.createElement("div");
    div.className="video";
    div.innerHTML=`
      <div class="player-wrap" onclick="togglePlay('${d.id}')">
        <div id="player-${d.id}"></div>
      </div>
      <div class="controls">
        <button id="like-${d.id}">★</button>
        <button id="watch-${d.id}">✔</button>
      </div>`;
    videos.appendChild(div);

    players[d.id]={youtubeId:v.youtubeId};
    waitForYT(()=>createPlayer(d.id,v.youtubeId));
    setupLike(d.id);
  });
}

function togglePlay(id){
  const p = players[id].player;
  if(!p) return;
  const state = p.getPlayerState();
  state === YT.PlayerState.PLAYING ? p.pauseVideo() : p.playVideo();
}

async function handleState(e,id){
  if(e.data===YT.PlayerState.PLAYING){
    if(currentPlaying && currentPlaying!==id){
      players[currentPlaying].player.pauseVideo();
    }
    currentPlaying=id;
  }

  if(e.data===YT.PlayerState.ENDED){
    const ref=doc(db,"interactions",`${currentUser.uid}_${id}`);
    const snap=await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref,{watched:true});
      await updateDoc(doc(db,"users",currentUser.uid),{balance:increment(0.5)});
      userData.balance+=0.5;
      balance.innerText=userData.balance+" ﷼";
    }
    document.getElementById(`watch-${id}`).classList.add("active");
  }
}

async function setupLike(id){
  const btn=document.getElementById(`like-${id}`);
  const ref=doc(db,"interactions",`${currentUser.uid}_${id}`);
  const snap=await getDoc(ref);
  if(snap.exists() && snap.data().liked) btn.classList.add("active");
  btn.onclick=async()=>{
    await setDoc(ref,{liked:true},{merge:true});
    btn.classList.add("active");
  };
}

window.openAdd=()=>addModal.style.display="flex";

window.saveVideo=async()=>{
  const url=yt.value.trim();
  let id="";
  if(url.includes("watch?v=")) id=url.split("watch?v=")[1].split("&")[0];
  else if(url.includes("youtu.be/")) id=url.split("youtu.be/")[1].split("?")[0];
  if(!id) return alert("رابط غير صحيح");
  await addDoc(collection(db,"videos"),{youtubeId:id,createdAt:Date.now()});
  location.reload();
};

window.toggleMenu=()=>{
  dropdown.style.display = dropdown.style.display==="flex" ? "none" : "flex";
};

document.addEventListener("click",e=>{
  if(!dropdown.contains(e.target) && !e.target.classList.contains("dots"))
    dropdown.style.display="none";
});

window.logout=()=>signOut(auth).then(()=>location.href="login.html");
</script>

</body>
</html>
