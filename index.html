<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>الرئيسية</title>

<style>
body {
  margin: 0;
  background: black;
  color: white;
  font-family: Arial;
  height: 100vh;
  overflow-y: scroll;
}

/* TOP BAR */
.topbar {
  position: fixed;
  top: 0;
  width: 100%;
  height: 55px;
  background: rgba(0,0,0,.8);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 15px;
  z-index: 1000;
}

.balance {
  font-size: 16px;
}

.menu {
  cursor: pointer;
  font-size: 22px;
}

.dropdown {
  position: absolute;
  top: 55px;
  right: 10px;
  background: #222;
  border-radius: 8px;
  display: none;
  flex-direction: column;
}

.dropdown button {
  background: none;
  border: none;
  color: white;
  padding: 10px;
  text-align: right;
  cursor: pointer;
}

/* VIDEOS */
.video {
  height: 100vh;
  margin-top: 55px;
}

/* ADD BUTTON */
.add-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  font-size: 30px;
  background: #3f8efc;
  border: none;
  border-radius: 50%;
  width: 55px;
  height: 55px;
  display: none;
  cursor: pointer;
}

/* MODAL */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: #111;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 350px;
}
</style>
</head>

<body>

<div class="topbar">
  <div class="balance" id="balance">0 ﷼</div>
  <div class="menu" onclick="toggleMenu()">⋮</div>

  <div class="dropdown" id="dropdown">
    <button id="username"></button>
    <button>معلومات المستخدم</button>
    <button onclick="logout()">تسجيل الخروج</button>
  </div>
</div>

<button class="add-btn" id="addBtn" onclick="openAdd()">＋</button>

<div class="modal" id="addModal">
  <div class="modal-content">
    <input id="yt" placeholder="رابط YouTube"><br><br>

    <label><input type="checkbox" value="الشرقية"> الشرقية</label><br>
    <label><input type="checkbox" value="الوسطى"> الوسطى</label><br>
    <label><input type="checkbox" value="الغربية"> الغربية</label><br><br>

    <button onclick="saveVideo()">حفظ الفيديو</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, doc, getDoc, collection, addDoc, getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyB4tTVOD8P95EUzmOFNkco9AKI0wP1dLW0",
  authDomain: "salh01.firebaseapp.com",
  projectId: "salh01"
});

const auth = getAuth();
const db = getFirestore();

let currentUser, userData;

onAuthStateChanged(auth, async user => {
  if (!user) location.href = "login.html";
  currentUser = user;

  const snap = await getDoc(doc(db, "users", user.uid));
  userData = snap.data();

  document.getElementById("username").innerText = userData.name;
  document.getElementById("balance").innerText = userData.balance + " ﷼";

  if (userData.role === "admin") {
    document.getElementById("addBtn").style.display = "block";
  }

  loadVideos();
});

async function loadVideos() {
  const snap = await getDocs(collection(db, "videos"));
  snap.forEach(d => {
    const v = d.data();
    if (!v.regions.includes(userData.region)) return;

    const div = document.createElement("div");
    div.className = "video";
    div.innerHTML = `
      <iframe width="100%" height="100%"
        src="https://www.youtube.com/embed/${v.youtubeId}?controls=0"
        frameborder="0"></iframe>`;
    document.body.appendChild(div);
  });
}

window.toggleMenu = () => {
  const d = document.getElementById("dropdown");
  d.style.display = d.style.display === "flex" ? "none" : "flex";
};

window.logout = () => signOut(auth).then(()=>location.href="login.html");

window.openAdd = () => document.getElementById("addModal").style.display = "flex";

window.saveVideo = async () => {
  const url = document.getElementById("yt").value;
  const id = url.split("v=")[1];
  const regions = [...document.querySelectorAll("input[type=checkbox]:checked")]
    .map(c => c.value);

  await addDoc(collection(db, "videos"), {
    youtubeId: id,
    regions,
    createdAt: new Date()
  });

  location.reload();
};
</script>

</body>
</html>
