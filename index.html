<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>الرئيسية</title>

<script src="https://www.youtube.com/iframe_api"></script>

<style>
body {
  margin: 0;
  background: black;
  color: white;
  font-family: Arial;
  height: 100vh;
  overflow-y: scroll;
  scroll-snap-type: y mandatory;
}

/* TOP BAR */
.topbar {
  position: fixed;
  top: 0;
  width: 100%;
  height: 55px;
  background: rgba(0,0,0,.85);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 15px;
  z-index: 1000;
}

.balance { font-size: 16px; }
.dots { font-size: 28px; cursor: pointer; }

.dropdown {
  position: absolute;
  top: 55px;
  right: 10px;
  background: #1e1e1e;
  border-radius: 10px;
  display: none;
  flex-direction: column;
  min-width: 180px;
}

.dropdown div, .dropdown button {
  padding: 12px;
  color: white;
  background: none;
  border: none;
  text-align: right;
}

/* VIDEO */
.video {
  height: 100vh;
  scroll-snap-align: start;
  position: relative;
}

iframe {
  width: 100%;
  height: 100%;
  pointer-events: none;
}

/* CONTROLS */
.controls {
  position: absolute;
  right: 15px;
  bottom: 120px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.controls button {
  background: rgba(0,0,0,.6);
  color: white;
  border: none;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  font-size: 18px;
}

.controls button.active {
  background: #3f8efc;
}
</style>
</head>

<body>

<div class="topbar">
  <div class="balance" id="balance">0 ﷼</div>
  <div class="dots" onclick="toggleMenu()">⋯</div>

  <div class="dropdown" id="dropdown">
    <div id="username"></div>
    <button onclick="alert('قريبًا')">معلومات المستخدم</button>
    <button onclick="logout()">تسجيل الخروج</button>
  </div>
</div>

<div id="videos"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, doc, getDoc, collection, getDocs,
  setDoc, updateDoc, increment
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyB4tTVOD8P95EUzmOFNkco9AKI0wP1dLW0",
  authDomain: "salh01.firebaseapp.com",
  projectId: "salh01"
});

const auth = getAuth();
const db = getFirestore();

let currentUser, userData;
let players = {};
let currentPlaying = null;

onAuthStateChanged(auth, async user => {
  if (!user) return location.href = "login.html";
  currentUser = user;

  const snap = await getDoc(doc(db, "users", user.uid));
  userData = snap.data();

  document.getElementById("username").innerText = userData.name;
  document.getElementById("balance").innerText = userData.balance + " ﷼";

  loadVideos();
});

async function loadVideos() {
  const snap = await getDocs(collection(db, "videos"));
  const container = document.getElementById("videos");

  snap.forEach(d => {
    const v = d.data();
    if (!v.regions.includes(userData.region)) return;

    const div = document.createElement("div");
    div.className = "video";
    div.innerHTML = `
      <div id="player-${d.id}"></div>
      <div class="controls">
        <button id="like-${d.id}">★</button>
        <button id="watch-${d.id}">✔</button>
      </div>
    `;
    container.appendChild(div);

    players[d.id] = { youtubeId: v.youtubeId };
    setupLike(d.id);
  });
}

window.onYouTubeIframeAPIReady = () => {
  Object.keys(players).forEach(id => {
    players[id].player = new YT.Player(`player-${id}`, {
      videoId: players[id].youtubeId,
      playerVars: { controls: 0 },
      events: {
        onStateChange: e => handleState(e, id)
      }
    });
  });
};

async function handleState(e, videoId) {
  if (e.data === YT.PlayerState.PLAYING) {
    if (currentPlaying && currentPlaying !== videoId) {
      players[currentPlaying].player.pauseVideo();
    }
    currentPlaying = videoId;
  }

  if (e.data === YT.PlayerState.ENDED) {
    const ref = doc(db, "interactions", `${currentUser.uid}_${videoId}`);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      await setDoc(ref, { watched: true });
      await updateDoc(doc(db, "users", currentUser.uid), {
        balance: increment(0.5)
      });
      document.getElementById("balance").innerText =
        (userData.balance += 0.5) + " ﷼";
    }

    document.getElementById(`watch-${videoId}`).classList.add("active");
  }
}

async function setupLike(videoId) {
  const btn = document.getElementById(`like-${videoId}`);
  const ref = doc(db, "interactions", `${currentUser.uid}_${videoId}`);
  const snap = await getDoc(ref);

  if (snap.exists() && snap.data().liked) btn.classList.add("active");

  btn.onclick = async () => {
    await setDoc(ref, { liked: true }, { merge: true });
    btn.classList.add("active");
  };
}

/* UI */
window.toggleMenu = () => {
  const d = document.getElementById("dropdown");
  d.style.display = d.style.display === "flex" ? "none" : "flex";
};

document.addEventListener("click", e => {
  const m = document.getElementById("dropdown");
  const d = document.querySelector(".dots");
  if (!m.contains(e.target) && !d.contains(e.target)) m.style.display = "none";
});

window.logout = () => signOut(auth).then(()=>location.href="login.html");
</script>

</body>
</html>
