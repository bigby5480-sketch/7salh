<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
<script src="https://www.youtube.com/iframe_api"></script>

<style>
body{
  margin:0;
  background:black;
  color:white;
  font-family:Arial;
  height:100vh;
  overflow-y:scroll;
  scroll-snap-type:y mandatory;
}

.video{
  height:100vh;
  scroll-snap-align:start;
  position:relative;
}

iframe{
  width:100%;
  height:100%;
  pointer-events:none;
}

.tap-layer{
  position:absolute;
  inset:0;
  z-index:5;
}

.add-btn{
  position:fixed;
  bottom:20px;
  right:20px;
  width:55px;
  height:55px;
  border-radius:50%;
  background:#3f8efc;
  color:white;
  font-size:30px;
  border:none;
  z-index:100;
  cursor:pointer;
}

.delete-btn{
  position:absolute;
  top:15px;
  left:15px;
  z-index:200;
  background:red;
  color:white;
  border:none;
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
}

.reward-overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.85);
  z-index:30;
  display:none;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  text-align:center;
  cursor:pointer;
}

.reward-overlay span{
  font-size:36px;
  margin-bottom:10px;
}

.yt-end-cover{
  position:absolute;
  bottom:0;
  left:0;
  width:100%;
  height:40%;
  background:black;
  z-index:20;
}

.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  justify-content:center;
  align-items:center;
  z-index:500;
}

.modal-content{
  background:#111;
  padding:20px;
  border-radius:10px;
  width:90%;
  max-width:350px;
}
</style>
</head>

<body>

<div id="videos"></div>

<button class="add-btn" onclick="openAdd()">ï¼‹</button>

<div class="modal" id="addModal">
  <div class="modal-content">
    <h3>Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ</h3><br>
    <input id="yt" placeholder="Ø±Ø§Ø¨Ø· YouTube"><br><br>
    <button onclick="saveVideo()">Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, getDocs, addDoc,
  doc, getDoc, setDoc, updateDoc, deleteDoc, increment
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyB4tTVOD8P95EUzmOFNkco9AKI0wP1dLW0",
  authDomain: "salh01.firebaseapp.com",
  projectId: "salh01"
});

const auth = getAuth();
const db = getFirestore();

let players = {};
let currentUser;
let currentPlaying = null;

onAuthStateChanged(auth,user=>{
  if(!user) location.href="login.html";
  currentUser=user;
  loadVideos();
});

function waitForYT(cb){
  if(window.YT && YT.Player) cb();
  else setTimeout(()=>waitForYT(cb),100);
}

function createPlayer(id,yt){
  players[id].player=new YT.Player(`player-${id}`,{
    videoId:yt,
    playerVars:{controls:0,rel:0,modestbranding:1,playsinline:1},
    events:{onStateChange:e=>handleState(e,id)}
  });
}

async function loadVideos(){
  const snap=await getDocs(collection(db,"videos"));
  const c=document.getElementById("videos");
  c.innerHTML="";

  snap.forEach(d=>{
    const v=d.data();
    const div=document.createElement("div");
    div.className="video";

    div.innerHTML=`
      <button class="delete-btn" onclick="deleteVideo('${d.id}')">Ø­Ø°Ù</button>
      <div id="player-${d.id}"></div>
      <div class="yt-end-cover"></div>
      <div class="reward-overlay" id="reward-${d.id}" onclick="replay('${d.id}')">
        <span>ğŸ‰ğŸ‘</span>
        <div>ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ 0.5 Ø±ÙŠØ§Ù„</div>
        <small>Ø´Ø§Ù‡Ø¯ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù„Ø²ÙŠØ§Ø¯Ø© Ø£Ø±Ø¨Ø§Ø­Ùƒ</small>
      </div>
      <div class="tap-layer" onclick="togglePlay('${d.id}')"></div>
    `;
    c.appendChild(div);

    players[d.id]={youtubeId:v.youtubeId};
    waitForYT(()=>createPlayer(d.id,v.youtubeId));
  });

  observeVideos();
}

function togglePlay(id){
  const p=players[id].player;
  p.getPlayerState()===1?p.pauseVideo():p.playVideo();
}

function replay(id){
  document.getElementById(`reward-${id}`).style.display="none";
  players[id].player.seekTo(0);
  players[id].player.playVideo();
}

async function handleState(e,id){
  if(e.data===1){
    if(currentPlaying && currentPlaying!==id)
      players[currentPlaying].player.pauseVideo();
    currentPlaying=id;
  }

  if(e.data===0){
    const ref=doc(db,"interactions",`${currentUser.uid}_${id}`);
    const snap=await getDoc(ref);

    if(!snap.exists()){
      await setDoc(ref,{watched:true});
      await updateDoc(doc(db,"users",currentUser.uid),{balance:increment(0.5)});
    }

    document.getElementById(`reward-${id}`).style.display="flex";
  }
}

function observeVideos(){
  const obs=new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      if(e.isIntersecting){
        const id=e.target.querySelector("[id^='player-']").id.replace("player-","");
        players[id].player.playVideo();
      }
    });
  },{threshold:0.7});

  document.querySelectorAll(".video").forEach(v=>obs.observe(v));
}

window.deleteVideo=async(id)=>{
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŸ")) return;
  await deleteDoc(doc(db,"videos",id));
  location.reload();
};

window.openAdd=()=>document.getElementById("addModal").style.display="flex";

window.saveVideo=async()=>{
  const url=document.getElementById("yt").value.trim();
  let id="";
  if(url.includes("watch?v=")) id=url.split("watch?v=")[1].split("&")[0];
  else if(url.includes("youtu.be/")) id=url.split("youtu.be/")[1].split("?")[0];
  if(!id) return alert("Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­");
  await addDoc(collection(db,"videos"),{youtubeId:id,createdAt:Date.now()});
  location.reload();
};
</script>
</body>
</html>
